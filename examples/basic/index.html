<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>OUYO Examples: Basic</title>
  </head>
  <body>
    <canvas id="canvas" width="800" height="600"></canvas>
    <p id="fps">???</p>

    <script src="../../lib/ouyo.js"></script>
    <script>
      const { Game, hasAll } = OUYO

      const canvas = document.getElementById('canvas')
      const fpsCounter = document.getElementById('fps')
      const ctx = canvas.getContext('2d')
      const WIDTH = canvas.width
      const HEIGHT = canvas.height
      const HEX_DIGITS = [
        '0', '1', '2', '3', '4', '5', '6', '7',
        '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'
      ]

      function Transform (x, y) {
        this.x = x
        this.y = y
      }
      Transform.id = 'Transform'

      function Velocity (x, y) {
        this.x = x
        this.y = y
      }
      Velocity.id = 'Velocity'

      function Rectangle (width, height, color) {
        this.width = width
        this.height = height
        this.color = color
      }
      Rectangle.id = 'Rectangle'

      const applyVelocity = {
        query: hasAll(Transform, Velocity),
        processEntity(entity, world, { timeDelta }) {
          const transform = entity.get(Transform)
          const velocity = entity.get(Velocity)

          transform.x += velocity.x * timeDelta
          transform.y += velocity.y * timeDelta
        }
      }

      const bounceOfEdges = {
        query: hasAll(Transform, Rectangle, Velocity),
        processEntity(entity) {
          const transform = entity.get(Transform)
          const rectangle = entity.get(Rectangle)
          const velocity = entity.get(Velocity)

          if(transform.x < 0) {
            velocity.x = -velocity.x
            transform.x = -transform.x
          }

          if(transform.x + rectangle.width > WIDTH) {
            velocity.x = -velocity.x
            transform.x = 2 * (WIDTH - rectangle.width) - transform.x
          }

          if(transform.y < 0) {
            velocity.y = -velocity.y
            transform.y = -transform.y
          }

          if(transform.y + rectangle.height > HEIGHT) {
            velocity.y = -velocity.y
            transform.y = 2 * (HEIGHT - rectangle.height) - transform.y
          }
        }
      }

      const clearScreen = {
        process() {
          ctx.fillStyle = 'black'
          ctx.fillRect(0, 0, WIDTH, HEIGHT)
        }
      }

      const renderRectangles = {
        query: hasAll(Transform, Rectangle),
        processEntity(entity) {
          const transform = entity.get(Transform)
          const rectangle = entity.get(Rectangle)

          ctx.fillStyle = rectangle.color
          ctx.fillRect(transform.x, transform.y, rectangle.width, rectangle.height)
        }
      }

      const lastFrames = []
      const showFps = {
        process(entities, world, { timeDelta }) {
          if(lastFrames.length === 20) {
            lastFrames.shift()
          }
          lastFrames.push(timeDelta)
          let avg = 0
          lastFrames.forEach(frame => avg += frame)
          avg /= lastFrames.length
          fpsCounter.innerHTML = (1 / avg).toPrecision(2) + ' FPS'
        }
      }

      const systems = [
        applyVelocity,
        bounceOfEdges,
        clearScreen,
        renderRectangles,
        showFps
      ]

      function init(world) {
        for(let i = 0; i < 1000; i++) {
          world.createEntity()
            .add(new Transform(random(0, WIDTH), random(0, HEIGHT)))
            .add(new Velocity(random(-300, 300), random(-300, 300)))
            .add(new Rectangle(random(10, 100), random(10, 100), randomColor()))
        }
      }

      function random(from, to) {
        return Math.random() * (from - to) + to
      }

      function choose(array) {
        return array[Math.floor(Math.random() * array.length)]
      }

      function randomColor() {
        let color = '#'
        for(let i = 0; i < 6; i++) {
          color += choose(HEX_DIGITS)
        }
        return color
      }

      new Game(systems, init).start()
    </script>
  </body>
</html>
