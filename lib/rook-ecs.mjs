var idSequence=0,Entity=function(){function t(t){this._components=Object.create(null),this._changeRegistered=!1,this.id=idSequence++,this._registerChange=t}return t.prototype.add=function(t){if(null==t)throw new Error("Entity.add :: Argument is not a component instance.");var e=t.constructor;if(!e||!e.id)throw new Error("Entity.add :: Argument is not a component instance.");if(this._components[e.id])throw new Error("Entity.add :: Component class already present.");return this._components[e.id]=t,this._onChange(),this},t.prototype.has=function(t){if(!t||!t.id)throw new Error("Entity.has :: Argument is not a component class.");return!!this._components[t.id]},t.prototype.get=function(t){if(!t||!t.id)throw new Error("Entity.get :: Argument is not a component class.");var e=this._components[t.id];if(!e)throw new Error("Entity.get :: Component class not present.");return e},t.prototype.remove=function(t){if(!t||!t.id)throw new Error("Entity.remove :: Argument is not a component class.");return this._components[t.id]=void 0,this._onChange(),this},t.prototype._onChange=function(){!this._changeRegistered&&this._registerChange&&(this._registerChange(this),this._changeRegistered=!0)},t}();function notifyAfterChangeRegistered(t){t._changeRegistered=!1}var Events=function(){function t(){this._events=[],this._eventTimes={}}return t.prototype.emit=function(t,e){"string"==typeof t&&(t={type:t});var n=this._eventTimes[t.type];null==n&&(n=e),t.timeDelta=e-n,this._eventTimes[t.type]=e,this._events.push(t)},t.prototype.get=function(t){return this._events.filter(function(e){return e.type===t})},t.prototype.clear=function(){this._events.length=0},t}(),GameWorld=function(){function t(t){var e=this;this._changedEntities=[],this._removedEntities=[],this._events=new Events,this._onEntityChange=function(t){return e._changedEntities.push(t)},this._queries=t}return Object.defineProperty(t.prototype,"time",{get:function(){return this._time||0},enumerable:!0,configurable:!0}),t.prototype.createEntity=function(t){var e=new Entity(this._onEntityChange);return t&&t(e),e},t.prototype.removeEntity=function(t){this._removedEntities.push(t)},t.prototype.emit=function(t){this._events.emit(t,this._time||0)},t.prototype._internal_getEvents=function(t){return this._events.get(t)},t.prototype._internal_tick=function(t){this._time=t,this._events.clear(),this.emit("tick")},t.prototype._internal_handleChanges=function(){for(var t=0,e=this._changedEntities;t<e.length;t++){for(var n=e[t],i=0,r=this._queries;i<r.length;i++){r[i].onChange(n)}notifyAfterChangeRegistered(n)}this._changedEntities.length=0;for(var o=0,s=this._removedEntities;o<s.length;o++){n=s[o];for(var u=0,h=this._queries;u<h.length;u++){h[u].onRemove(n)}}this._removedEntities.length=0},t}();function createQuery(t){return Array.isArray(t)?new MultiQuery(t):new SingleQuery(t)}var SingleQuery=function(){function t(t){if(this._entities=[],this._indexMap={},"function"!=typeof t)throw new Error("new Query :: selector must be a function");this._selector=t}return Object.defineProperty(t.prototype,"entities",{get:function(){return this._entities},enumerable:!0,configurable:!0}),t.prototype.onChange=function(t){this._selector(t)?null==this._indexMap[t.id]&&(this._indexMap[t.id]=this.entities.length,this._entities.push(t)):this.onRemove(t)},t.prototype.onRemove=function(t){var e=this._indexMap[t.id];if(null!=e){var n=this._entities.pop();n!==t&&(this._entities[e]=n,this._indexMap[n.id]=e)}},t}(),MultiQuery=function(){function t(t){this._queries=t.map(function(t){return new SingleQuery(t)})}return Object.defineProperty(t.prototype,"entities",{get:function(){return this._queries.map(function(t){return t.entities})},enumerable:!0,configurable:!0}),t.prototype.onChange=function(t){for(var e=0,n=this._queries;e<n.length;e++){n[e].onChange(t)}},t.prototype.onRemove=function(t){for(var e=0,n=this._queries;e<n.length;e++){n[e].onRemove(t)}},t}();function toInternalSystem(t){var e=isIterativeSystem(t)?createProcess(t.processEntity):t.process;return{query:t.query&&createQuery(t.query),on:t.on||"tick",process:e}}function isIterativeSystem(t){return!t.process}function createProcess(t){return function(e,n,i){for(var r=0,o=e;r<o.length;r++){var s=o[r];t(s,n,i)}}}var Game=function(){function t(t,e){this._systems=[],this._systems=t.map(toInternalSystem),this._world=new GameWorld(this._systems.map(function(t){return t.query}).filter(function(t){return!!t})),e&&e(this._world)}return t.prototype.update=function(t){this._world._internal_tick(t);for(var e=0,n=this._systems;e<n.length;e++)for(var i=n[e],r=0,o=this._world._internal_getEvents(i.on);r<o.length;r++){var s=o[r];this._world._internal_handleChanges();var u=i.query?i.query.entities:[];i.process(u,this._world,s)}},t.prototype.start=function(){var t=this,e=function(){requestAnimationFrame(e),t.update(Date.now()/1e3)};e()},t}();function hasAll(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!t.every(isComponent))throw new Error("hasAll :: All arguments must be components.");return function(e){return t.every(function(t){return e.has(t)})}}function hasAny(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!t.every(isComponent))throw new Error("hasAny :: All arguments must be components.");return function(e){return t.some(function(t){return e.has(t)})}}function isComponent(t){return t&&t.id}export{Game,hasAll,hasAny,Entity};
//# sourceMappingURL=rook-ecs.mjs.map
